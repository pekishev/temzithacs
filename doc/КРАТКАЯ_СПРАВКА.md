# Краткая справка по протоколу сохранения настроек

## Основные параметры

- **Протокол**: TCP Socket
- **IP**: 192.168.4.1 (по умолчанию)
- **Порт**: 333 (официальная документация ТЭМЗИТ)
- **Размер ответа**: 64 байта

**Примечание:** Протокол соответствует [официальной документации ТЭМЗИТ](https://temzit.ru/downloads/HM_Protocol.pdf) с некоторыми расширениями. См. `СРАВНЕНИЕ_С_ОФИЦИАЛЬНЫМ_ПРОТОКОЛОМ.md` для деталей.

## Типы пакетов для сохранения

| Тип | Код | Размер | Описание |
|-----|-----|--------|----------|
| SEND_SETTINGS | 0x35 (53) | 32 байта | Отправка всех настроек |
| CHANGE_ONE_SETTING | 0x32 (50) | 8 байт | Изменение одного параметра |
| SEND_RTCSETTINGS | 0x37 (55) | 42 байта | Отправка расписания |
| CHANGE_ONE_RTCSETTING | 0x33 (51) | 8 байт | Изменение параметра расписания |

## Структура пакета SEND_SETTINGS

```
[0x35] [0x1A] [26 байт данных] [3 байта резерв] [CRC]
```

**Пример:**
```
35 1A 01 10 1E 00 F6 E7 05 23 00 00 0A 05 00 01 06 13 59 0F 03 00 00 00 0F 00 00 05 5A 00 [CRC]
```

## Структура пакета CHANGE_ONE_SETTING

```
[0x32] [0x00] [0x00] [номер_параметра] [0x00] [значение] [0x00] [CRC]
```

**Пример (изменить параметр 0 на значение 1):**
```
32 00 00 00 00 01 00 [CRC]
```

## Вычисление CRC

CRC = сумма всех байтов до CRC (младший байт)

```python
crc = sum(packet[0:crc_index]) & 0xFF
packet[crc_index] = crc
```

## Формат данных настроек

Настройки хранятся в HEX строке:
- **Основные настройки**: 52 символа (26 байт)
- **Расписание (RTC)**: 80 символов (40 байт)

## Карта параметров (байты в config)

- **Байт 0**: Режим работы
- **Байт 1**: Температура в помещении (значение = байт - 16)
- **Байт 2**: Температура воды (значение зависит от версии)
- **Байт 3**: ТЭН режим (биты 0-1) + Коэффициент инерции (биты 4-7)
- **Байт 4**: Температура включения ТЭНа (значение = байт + 25)
- **Байт 5**: Температура выключения компрессора (значение = байт + 25)
- **Байт 6**: Режим ГВС (биты 0-3)
- **Байт 7**: Температура ГВС (значение = байт - 20)
- **Байт 8**: Внешний нагреватель (биты 0-3)
- **Байт 9**: Ограничение мощности компрессора
- **Байт 18**: Погодокомпенсация
- **Байт 21**: Максимальная температура нагрева от ТН

## Быстрый старт

1. Установить TCP соединение с 192.168.4.1
2. Подготовить пакет с настройками
3. Вычислить CRC
4. Отправить пакет
5. Получить ответ (64 байта)
6. Проверить CRC ответа

## Протокол чтения данных сенсоров

### Запрос данных (GET_STATE)

**Запрос:**
```
[0x30] [0x00]
```

**Ответ:** 64 байта
```
[0x00/0x01] [резерв] [данные...] [CRC]
```

### Структура данных ответа

| Смещение | Размер | Описание | Формат |
|----------|--------|----------|--------|
| 0 | 1 | Тип (0x00 или 0x01) | byte |
| 2-3 | 2 | Состояние | word (LE) |
| 4-5 | 2 | Расписание | word (LE) |
| 6-7 | 2 | Tout (°C) | int16 / 10.0 |
| 8-9 | 2 | Tin (°C) | int16 / 10.0 |
| 10-11 | 2 | Tf (°C) | int16 / 10.0 |
| 12-13 | 2 | Tb (°C) | int16 / 10.0 |
| 14-15 | 2 | Tcond (°C) | int16 / 10.0 |
| 16-17 | 2 | Tevap (°C) | int16 / 10.0 |
| 18-19 | 2 | Tgvs (°C) | int16 / 10 |
| 20-21 | 2 | Flow (л/мин) | word: младший=Flow, старший=Flow2 |
| 24-25 | 2 | CompFreq (Гц) | word: младший=CompFreq, старший=CompFreq2 |
| 30-31 | 2 | Pin (кВт) | int16 / 10.0 |
| 32-33 | 2 | Failures | word |
| 34-35 | 2 | Tf2 (°C) | int16 / 10.0 |
| 36-37 | 2 | Tb2 (°C) | int16 / 10.0 |
| 38-39 | 2 | Tcond2 (°C) | int16 / 10.0 |
| 40-41 | 2 | Tevap2 (°C) | int16 / 10.0 |
| 44 | 1 | Флаги (бит 0: Dualmode) | byte |
| 45-46 | 2 | Ревизия контроллера | byte[45]*100 + byte[46] |
| 47 | 1 | Текущая страница | byte |
| 48 | 1 | Режим установлен | byte |
| 49 | 1 | Начало расписания (часы) | byte |
| 50 | 1 | Конец расписания (часы) | byte |
| 51 | 1 | TroomSet | byte |
| 52 | 1 | TwaterSet | byte |
| 53 | 1 | TgvsSet | byte |
| 56 | 1 | GVSModeSet | byte |
| 59-61 | 3 | Время (BCD) | BCD формат |
| 62-63 | 2 | CRC | word (LE) |

### Формат данных

- **Word**: 16-битное значение, little-endian (младший байт первый)
- **Int16**: 16-битное знаковое число, для температур делится на 10
- **BCD время**: Двоично-десятичный код
  - Байт 59: часы (старший полубайт = десятки, младший = единицы)
  - Байт 60: минуты (аналогично)
  - Байт 61: секунды (аналогично)

### Состояния устройства

- `0`: стоп
- `1-4`: нагрев
- `5`: холод
- `100-103`: ГВС

### Вычисление выходной мощности

```
Pout = ((Flow * 1.25 * 60.0 * (Tf - Tb)) / 100.0) / 10.0
```

## Примеры использования

См. файл `пример_реализации.py` для полной реализации на Python.

